# Step Ledger

Use `SELF` in the Commit/PR column for the commit that implements the step.

| Step ID | Date | Commit/PR | Summary | Notes |
| --- | --- | --- | --- | --- |
| 1.1 | 2026-02-09 | 255ba44 | Add governance artifacts (AGENTS, decisions, ledger). |  |
| 1.6 | 2026-02-09 | SELF | Add local infra compose, env examples, and docs. |  |
| 1.5 | 2026-02-09 | 837b639 | Add GitHub Actions CI checks for repo safety rails. |  |
| 1.6.1 | 2026-02-09 | SELF | Standardize ledger commit value for self-implementing steps. |  |
| 1.7 | 2026-02-09 | SELF | Scaffold core packages (core/mail/telemetry/db). |  |
| 1.8 | 2026-02-09 | SELF | DB migrations scaffold added. |  |
| 1.9 | 2026-02-10 | SELF | API and worker smoke boot with healthz. |  |
| 2.1 | 2026-02-10 | SELF | Added/updated DR-0001 tech stack and added DR-0007 Phase 2 architecture lock. |  |
| 2.2 | 2026-02-10 | SELF | Added architecture overview doc defining boundaries and event pipeline. |  |
| 2.3 | 2026-02-10 | SELF | Defined canonical contracts for MailProvider, event pipeline, AI boundary, and auditability. |  |
| 2.4 | 2026-02-10 | SELF | Added minimal data model spec for Phase 2. |  |
| 2.5 | 2026-02-10 | SELF | Added initial Postgres migrations for minimal multi-tenant schema. |  |
| 2.6 | 2026-02-10 | SELF | Added Postgres RLS tenant isolation policies + verification script. |  |
| 2.7 | 2026-02-10 | SELF | Added canonical mail models and MailProvider interface in shared package. |  |
| 2.8 | 2026-02-10 | SELF | Added GmailProvider adapter scaffold implementing MailProvider (stubbed). |  |
| 2.8.1 | 2026-02-10 | SELF | Added mail-gmail README with construction examples. |  |
| 2.9 | 2026-02-10 | SELF | Added runtime mail provider registry composition root (gmail wired, outlook placeholder). |  |
| 2.10 | 2026-02-10 | SELF | Added shared pipeline job + run + audit contract types. |  |
| 2.11 | 2026-02-10 | SELF | Added shared queue naming + retry defaults + envelope helper. |  |
| 2.12 | 2026-02-10 | SELF | Phase 2 closeout doc with decisions, evidence gate, milestone map, and next backlog. |  |
| 6.1 | 2026-02-10 | SELF | Define provider-agnostic MailProvider Thread+Draft contract (types/interfaces only). |  |
| 6.2 | 2026-02-10 | SELF | Define Copilot label namespace + thread state mapping constants. |  |
| 6.2.1 | 2026-02-10 | SELF | Patch Copilot label set to include Ready and align state mapping. |  |
| 6.3 | 2026-02-10 | SELF | Define v1 eligibility + sensitive triage rules as shared pure helpers. |  |
| 6.3.1 | 2026-02-10 | SELF | Fix triage reason taxonomy for user-draft presence (needs_review reason). |  |
| 6.4 | 2026-02-10 | SELF | Define cursor-based ingestion contract + canonical system label normalization rule. |  |
| 6.5 | 2026-02-10 | SELF | Define Copilot draft marker + fingerprint helpers to prevent overwriting human edits. |  |
| 6.6 | 2026-02-10 | SELF | Define thread-scoped concurrency + ordering + idempotency contract. |  |
| 6.7 | 2026-02-10 | SELF | Define v1 draft lifecycle state machine planner (shared) + contract doc. |  |
| 6.8 | 2026-02-10 | SELF | Define failure taxonomy + retry/resync contract helpers. |  |
| 6.9 | 2026-02-10 | SELF | Define telemetry event schema + Phase 6 evidence metrics. |  |
| 6.10 | 2026-02-10 | SELF | Phase 6 closeout: DR + evidence gate + Phase 7 milestone/backlog. |  |
| 7.2 | 2026-02-10 | SELF | Phase 7: knowledge taxonomy + doc priority + metadata/staleness spec. |  |
| 7.3 | 2026-02-10 | SELF | Phase 7: ingestion pipeline spec (upload→parse→chunk→embed→index) + idempotency/failure states. |  |
| 7.4 | 2026-02-10 | SELF | Phase 7: chunking + operator-visible citation scheme spec. |  |
| 7.5 | 2026-02-10 | SELF | Phase 7: retrieval & ranking spec (hybrid search, precedence, staleness, evidence packs). |  |
| 7.6 | 2026-02-10 | SELF | Phase 7: conflict + staleness handling spec (deterministic escalation + reason codes). |  |
| 7.7 | 2026-02-10 | SELF | Phase 7: unknown rules + evaluation plan (grounding metrics + evidence gate). |  |
| 7.1 | 2026-02-10 | SELF | Phase 7 closeout: DR-0005 + evidence gate + Phase 8 milestones/backlog. |  |
| 8.1 | 2026-02-10 | SELF | Added Phase 8 guardrails Decision Record (matrix + forbidden list). |  |
| 8.1.1 | 2026-02-10 | SELF | Renumbered Phase 2 architecture lock DR to resolve duplicate 0003 numbering. |  |
| 8.2 | 2026-02-10 | SELF | Added Phase 8 guardrail taxonomy examples bank (v1). |  |
| 8.3 | 2026-02-10 | SELF | Added Phase 8 classification policy spec (rules → AI → policy engine). |  |
| 8.4 | 2026-02-10 | SELF | Added Phase 8 audit logging + privacy spec (v1). |  |
| 8.5 | 2026-02-10 | SELF | Added Phase 8 operator review UX spec (Gmail-first). |  |
| 8.6 | 2026-02-10 | SELF | Added Phase 8 golden dataset + evaluation plan (v1). |  |
| 8.7 | 2026-02-10 | SELF | Added Phase 8 tenant customization boundaries spec (v1). |  |
| 9.1 | 2026-02-12 | SELF | Added Phase 9 Decision Record for operator setup + minimal admin UX. |  |
| 9.2 | 2026-02-12 | SELF | Scaffolded admin IA routes + page stubs for onboarding, docs, tone/policies, and health (Phase 9). |  |
| 9.3 | 2026-02-12 | SELF | Added onboarding wizard shell with stepper + local persistence (Phase 9). |  |
| 9.3.1 | 2026-02-12 | SELF | Aligned onboarding wizard steps to 5-step Phase 9 flow (Profile, Gmail, Docs, Defaults, Enable Drafts). |  |
| 9.4 | 2026-02-12 | SELF | Added mocked Gmail connection UX states + test connection UI in onboarding. |  |
| 9.6 | 2026-02-12 | SELF | Added mocked docs upload + categorization UI with status chips and local persistence. |  |
| 9.8 | 2026-02-12 | SELF | Added mocked tone + escalation policies UI with local persistence and preview. |  |
| 9.10 | 2026-02-12 | SELF | Added Enable Drafts gating step based on Gmail connection + indexed docs, with local persistence. |  |
| 9.5 | 2026-02-12 | SELF | Implemented real Gmail OAuth connect endpoints + persisted tenant connection state (admin wired behind env). |  |
| 9.5.1 | 2026-02-12 | SELF | Hardened Gmail OAuth state storage with Redis TTL + one-time consume and tightened tenant resolution rules. |  |
| 9.5.2 | 2026-02-12 | SELF | Fixed admin status fetch by sending x-tenant-id header (env-driven) to match tightened tenant resolution. |  |
| 9.7 | 2026-02-12 | SELF | Implemented real docs upload to S3 + persisted doc records and ingestion triggering; admin wired behind env with localStorage sync. |  |
| 9.9 | 2026-02-12 | SELF | Implemented System Health dashboard with real Gmail + docs signals (env-gated) and clear placeholders. |  |
| 9.11 | 2026-02-12 | SELF | Closed out Phase 9 (operator setup + minimal admin UX) with evidence gate and milestone map. |  |
| 10.1 | 2026-02-12 | SELF | Added Phase 10 reliability/observability baseline DR + pilot runbook skeleton. |  |
| 10.2 | 2026-02-12 | SELF | Defined queue taxonomy + typed job contracts in shared package. |  |
| 10.2.1 | 2026-02-12 | SELF | Tightened queue contracts: ingest cursor union + provider ID meta typing. |  |
| 10.7 | 2026-02-12 | SELF | Added structured logging baseline + correlationId alignment across shared/API/worker. |  |
| 10.7.1 | 2026-02-12 | SELF | Hardened correlationId + safe structured logging (helpers + enqueue defaults). |  |
| 10.0.1 | 2026-02-12 | SELF | Strengthened repo:check with workspace TypeScript typecheck gate. |  |
| 10.0.2 | 2026-02-12 | SELF | Added safe Turbo typecheck wrapper scripts and documented no-flag-forwarding usage. |  |
| 10.0.3 | 2026-02-12 | SELF | Added runbook preflight + install guardrails with root preflight script. |  |
| 10.0.4 | 2026-02-12 | SELF | Gated PRs/main pushes with CI running install (frozen), preflight, and repo:check. |  |
| 10.0.5 | 2026-02-12 | SELF | Guarded typecheck entrypoint against arg forwarding and documented fail-fast usage. |  |
| 10.7.2 | 2026-02-12 | SELF | Added correlation E2E smoke harness and deterministic runbook verification steps. | Checks: `pnpm -w preflight`; `pnpm -w repo:check`; `pnpm -w typecheck:full`. |
| 10.7.3 | 2026-02-13 | SELF | Fixed API tenant header resolution for `x-tenant-id` by using Fastify lowercase header lookup with normalized string/array handling. | Checks: `pnpm -w repo:check`; `pnpm -w smoke:correlation`. |
| 10.7.4 | 2026-02-13 | SELF | Added docs local-storage fallback (`DOCS_STORAGE=local`) so `/v1/docs` and smoke correlation work without AWS/S3 buckets. | Checks: `pnpm -w repo:check`; `DOCS_STORAGE=local pnpm -w smoke:correlation`. |
| 10.7.5 | 2026-02-13 | SELF | Added guarded dev tenant auto-seed for docs ingest and improved DB error surfacing for document record failures. | Checks: `pnpm -w repo:check`; `DOCS_STORAGE=local TENANT_AUTOSEED=1 pnpm -w smoke:correlation`. |
| 10.7.6 | 2026-02-13 | SELF | Added deterministic local Postgres bootstrap (`pnpm -w db:setup`) and runbook instructions for fully green local smoke. | Checks: `pnpm -w repo:check`; `pnpm -w db:setup`; `pnpm -w smoke:correlation` (with API/worker + Redis running). |
| 10.7.7 | 2026-02-13 | SELF | Added pgvector Homebrew link/remediation in `db:setup` (symlink extension files, restart, verify availability) and documented fallback/manual commands in runbook. | Checks: `pnpm -w repo:check`. |
| 10.7.8 | 2026-02-13 | SELF | Hardened pgvector remediation to use `brew list pgvector`, avoid self-referential links, copy extension files into Postgres extension dir, and fail fast with explicit reinstall/Docker guidance when files are missing. | Checks: `pnpm -w repo:check`. |
| 10.7.9 | 2026-02-13 | SELF | Replaced pgvector file-copy remediation with Postgres-16 source build/install (`make ... PG_CONFIG=<postgresql@16>/bin/pg_config`) plus TCP `pg_available_extensions` verification and restart/recheck flow. | Checks: `pnpm -w repo:check`; `pnpm -w db:setup`. |
| 10.7.10 | 2026-02-13 | SELF | Hardened `db:setup` pgvector flow to resolve `pg_config` from `brew --prefix postgresql@16`, centralize actionable failure guidance, and require final `pg_available_extensions` verification before success exit. | Checks: `pnpm -w repo:check`; `pnpm -w db:setup`. |
| 10.7.11 | 2026-02-13 | SELF | Fixed tenant DB scoping to use parameter-safe transaction-local `SELECT set_config('app.tenant_id', $1, true)` in API and worker instead of invalid `SET LOCAL ... = $1`. | Checks: `pnpm -w repo:check`; `DATABASE_URL=postgresql://127.0.0.1:5432/ai_email_dev pnpm -w db:migrate`; `TENANT_AUTOSEED=1 pnpm -w smoke:correlation` (with API + worker running). |
| 10.7.12 | 2026-02-13 | SELF | Made local smoke log verification deterministic: API emits JSON `notification.received`/`notification.enqueued` with `correlationId`, worker emits `job.start`/`job.done`/`job.error` with `correlationId` + attempt/error fields, and smoke/runbook now point to `/tmp/ai-email-api.log` + `/tmp/ai-email-worker.log` grep flow. | Checks: `pnpm -w repo:check`; `pnpm -w smoke:correlation`; `rg -a "$CID" /tmp/ai-email-api.log | rg -e "notification.received|notification.enqueued"`; `rg -a "$CID" /tmp/ai-email-worker.log | rg -e "job.start|job.done|job.error"`. |
| 10.7.13 | 2026-02-13 | SELF | Added `dev:up`/`dev:down` local orchestration scripts and tightened smoke verification to require API/worker evidence with matching `correlationId` + `jobId`. | Checks: `pnpm -w repo:check`; `pnpm -w dev:up` (then Ctrl+C); `pnpm -w smoke:correlation`; `pnpm -w dev:down`. |
| 10.7.14 | 2026-02-13 | SELF | Added GitHub Actions CI workflow with Redis + Postgres16/pgvector services, DB migration + deterministic smoke correlation gate, and failure-time API/worker log artifacts for debugging. | Evidence: GitHub Actions CI workflow green on PR/push; local checks: `pnpm -w repo:check`; `pnpm -w smoke:correlation`. |
| 10.7.15 | 2026-02-13 | SELF | Hardened CI lifecycle (workflow concurrency, timeout, reliable PID-based process cleanup + port fallback), added required-check guidance in runbook, and added CI badge to README. | Checks: `pnpm -w repo:check`; CI validated via Actions run; `ci-smoke-logs` artifact available on failure. |
| 10.8.1 | 2026-02-13 | SELF | Added shared reliability module for error taxonomy and retry/backoff defaults, and wired docs ingestion queue defaults to shared BullMQ policy. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `pnpm -w dev:down`. |
| 10.8.2 | 2026-02-13 | SELF | Enforced worker retry semantics from shared taxonomy: transient errors retry; permanent errors fail fast without retries, with `errorClass` included in `job.error` logs. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `pnpm -w dev:down`. |
| 10.8.3 | 2026-02-13 | SELF | Added a manual, deterministic replay workflow for failed BullMQ jobs (`docs_ingestion` default) with safe dry-run behavior and explicit confirm gating. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `REDIS_URL=\"redis://127.0.0.1:6379\" pnpm -w queue:replay`; `pnpm -w dev:down`. |
| 10.8.4 | 2026-02-13 | SELF | Added docs ingestion kill switches: global env disable and per-tenant Postgres switch, enforced in API pre-enqueue path and worker pre-processing path with explicit rejection/ignored events. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `pnpm -w dev:down`. |
| 10.8.5 | 2026-02-13 | SELF | Hardened tenant kill switch timestamp correctness (`updated_at` trigger on update) and added deterministic `kill-switch:set` operator command with dry-run by default and explicit confirm for writes. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" TENANT_ID=\"00000000-0000-0000-0000-000000000001\" KEY=\"docs_ingestion\" IS_ENABLED=\"0\" REASON=\"test\" pnpm -w kill-switch:set`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" TENANT_ID=\"00000000-0000-0000-0000-000000000001\" KEY=\"docs_ingestion\" IS_ENABLED=\"0\" REASON=\"test\" KILL_SWITCH_CONFIRM=1 pnpm -w kill-switch:set`; `pnpm -w dev:down`. |
| 10.8.6 | 2026-02-13 | SELF | Added deterministic, read-only `queue:status` operator command for BullMQ queue health snapshots (counts + active/failed samples with stable output and optional filters). | Evidence: `pnpm -w repo:check`; `REDIS_URL=\"redis://127.0.0.1:6379\" pnpm -w queue:status`; `REDIS_URL=\"redis://127.0.0.1:6379\" TENANT_ID=\"00000000-0000-0000-0000-000000000001\" pnpm -w queue:status`. |
| 10.8.7 | 2026-02-13 | SELF | Added safe-by-default operator queue control command for BullMQ pause/resume/check status with explicit confirm gating for mutations. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `REDIS_URL=\"redis://127.0.0.1:6379\" pnpm -w queue:is-paused`; `REDIS_URL=\"redis://127.0.0.1:6379\" pnpm -w queue:pause`; `REDIS_URL=\"redis://127.0.0.1:6379\" QUEUE_CONTROL_CONFIRM=1 pnpm -w queue:pause`; `REDIS_URL=\"redis://127.0.0.1:6379\" pnpm -w queue:is-paused`; `REDIS_URL=\"redis://127.0.0.1:6379\" QUEUE_CONTROL_CONFIRM=1 pnpm -w queue:resume`; `pnpm -w smoke:correlation`; `pnpm -w dev:down`. |
| 10.8.8 | 2026-02-13 | SELF | Persisted docs ingestion failures in tenant-scoped Postgres storage and added deterministic operator commands to list/show failures for fast pilot triage. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" TENANT_ID=\"00000000-0000-0000-0000-000000000001\" pnpm -w failures:list`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" TENANT_ID=\"00000000-0000-0000-0000-000000000001\" JOB_ID=\"job-10.8.8-test\" pnpm -w failures:show`; `pnpm -w dev:down`. |
| 10.8.9 | 2026-02-14 | SELF | Added read-only one-shot `ops:triage` operator command that emits deterministic JSON for global/tenant kill switches, queue paused/counts/samples, and tenant failure count/samples with strict validation and correlation filtering. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `REDIS_URL=\"redis://127.0.0.1:6379\" DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" TENANT_ID=\"00000000-0000-0000-0000-000000000001\" pnpm -w ops:triage`; `pnpm -w dev:down`. |
| 10.8.10 | 2026-02-14 | SELF | Hardened `dev:up` with default log truncation (`KEEP_LOGS=1` override), hard API `/healthz` readiness timeout with fail-fast tail output, soft worker readiness warning, and deterministic ready line for smoke sequencing. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `pnpm -w dev:down`; `KEEP_LOGS=1 pnpm -w dev:up`; `pnpm -w dev:down`. |
| 10.8.11 | 2026-02-14 | SELF | Made `dev:up` deterministically own port `3001` with listener detection, TERM/KILL reclaim + verification, fail-fast PID diagnostics/manual commands when unreclaimed, and startup stale state-file cleanup before boot. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `node -e \"require('http').createServer(() => {}).listen(3001); setInterval(() => {}, 1 << 30)\"`; `lsof -nP -iTCP:3001 -sTCP:LISTEN`; `pnpm -w dev:up`; `lsof -nP -iTCP:3001 -sTCP:LISTEN \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `pnpm -w dev:down`; `lsof -nP -iTCP:3001 -sTCP:LISTEN \\|\\| true`. |
| 10.8.12 | 2026-02-14 | SELF | Added docs ingestion idempotency/de-dupe: deterministic BullMQ job IDs from `docId`, retry rejection for already ingested docs, and worker ingestion-status guards to no-op duplicate processing safely. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `DOC_ID=$(curl -sS -H \"x-tenant-id: 00000000-0000-0000-0000-000000000001\" http://127.0.0.1:3001/v1/docs | node -e \"let d='';process.stdin.on('data',c=>d+=c).on('end',()=>{const a=JSON.parse(d);console.log((a[0]&&a[0].id)||'');});\")`; `curl -i -sS -X POST -H \"x-tenant-id: 00000000-0000-0000-0000-000000000001\" \"http://127.0.0.1:3001/v1/docs/$DOC_ID/retry\"`; `rg -a \"notification.retry.rejected\" /tmp/ai-email-api.log`; `pnpm -w dev:down`. |
| 10.8.13 | 2026-02-14 | SELF | Added safe-by-default `docs:unstick` operator command to detect and unstick stale `processing` docs rows (threshold-based), with deterministic JSON output, dry-run default, and confirm-gated status transition to `failed` or `queued`. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `DOC_ID=$(curl -sS -H \"x-tenant-id: 00000000-0000-0000-0000-000000000001\" http://127.0.0.1:3001/v1/docs | node -e \"let d='';process.stdin.on('data',c=>d+=c).on('end',()=>{const a=JSON.parse(d);console.log((a[0]&&a[0].id)||'');});\")`; `/opt/homebrew/opt/postgresql@16/bin/psql \"postgresql://127.0.0.1:5432/ai_email_dev\" -c \"UPDATE docs SET ingestion_status='processing', ingestion_status_updated_at=now()-interval '120 minutes' WHERE tenant_id='00000000-0000-0000-0000-000000000001'::uuid AND id='$DOC_ID'::uuid;\"`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" TENANT_ID=\"00000000-0000-0000-0000-000000000001\" THRESHOLD_MINUTES=\"60\" pnpm -w docs:unstick`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" TENANT_ID=\"00000000-0000-0000-0000-000000000001\" THRESHOLD_MINUTES=\"60\" DOCS_UNSTICK_CONFIRM=1 pnpm -w docs:unstick`; `/opt/homebrew/opt/postgresql@16/bin/psql \"postgresql://127.0.0.1:5432/ai_email_dev\" -c \"SELECT id, tenant_id, ingestion_status, ingestion_status_updated_at FROM docs WHERE tenant_id='00000000-0000-0000-0000-000000000001'::uuid AND id='$DOC_ID'::uuid;\"`; `pnpm -w dev:down`. |
| 10.8.14 | 2026-02-14 | SELF | Added read-only `ops:monitor` operator command for deterministic monitoring snapshots and v1 threshold evaluation (`OK/WARN/ALERT`) using Redis queue + Postgres ingestion/failure state, with automation-ready exit codes. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `REDIS_URL=\"redis://127.0.0.1:6379\" DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" TENANT_ID=\"00000000-0000-0000-0000-000000000001\" pnpm -w ops:monitor`; `pnpm -w dev:down`. |
| 10.8.15 | 2026-02-14 | SELF | Added safe-by-default `ops:alert-drill` operator command to deterministically simulate an ALERT condition, verify `ops:monitor` alert status/exit code, perform cleanup, and re-verify healthy monitor state. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `REDIS_URL=\"redis://127.0.0.1:6379\" DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" TENANT_ID=\"00000000-0000-0000-0000-000000000001\" pnpm -w ops:alert-drill`; `REDIS_URL=\"redis://127.0.0.1:6379\" DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" TENANT_ID=\"00000000-0000-0000-0000-000000000001\" ALERT_DRILL_CONFIRM=1 pnpm -w ops:alert-drill`; `pnpm -w dev:down`. |
| 10.9.1 | 2026-02-15 | SELF | Froze Phase 10 reliability policy and roadmap with DR-0011, a Phase 10 evidence gate/milestone/backlog doc, and pilot runbook links for fast operator discovery. | Checks: `pnpm -w repo:check`. |
| 10.9.2 | 2026-02-15 | SELF | Added `mail_notification_receipts` ledger migration + RLS, Gmail Pub/Sub receipt insert-once dedupe at API boundary, and deterministic `smoke:notify-dedupe` proof to enforce one-row receipt behavior per `(tenant,provider,messageId)`. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" pnpm -w smoke:notify-dedupe`; `pnpm -w dev:down`. |
| 10.9.3 | 2026-02-15 | SELF | Added enqueue-once Gmail notification fanout gate: receipt row lock + `enqueued_at`/`enqueued_job_id` markers, deterministic `mail_notifications` queue worker skeleton, and `smoke:notify-fanout` proof for single enqueue + single job processing under duplicate delivery. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" pnpm -w smoke:notify-dedupe`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" REDIS_URL=\"redis://127.0.0.1:6379\" pnpm -w smoke:notify-fanout`; `pnpm -w dev:down`. |
| 10.9.4 | 2026-02-15 | SELF | Added mailbox-level HistoryId cursor coalescing with `mailbox_sync_state` RLS table, coalesced `mailbox_sync` enqueue gate, worker cursor advancement (`last_history_id <- pending_max_history_id`), and deterministic `smoke:notify-coalesce` proof. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `pnpm -w smoke:notify-dedupe`; `pnpm -w smoke:notify-fanout`; `pnpm -w smoke:notify-coalesce`; `pnpm -w dev:down`. |
| 10.9.5 | 2026-02-15 | SELF | Hardened Gmail HistoryId precision and mailbox cursor invariants: added DB constraint/data-fix (`pending_max_history_id >= last_history_id`), SQL-only monotonic cursor updates, and deterministic `smoke:notify-historyid` proof using `9007199254740993` (>2^53). | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" pnpm -w smoke:notify-dedupe`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" REDIS_URL=\"redis://127.0.0.1:6379\" pnpm -w smoke:notify-fanout`; `pnpm -w smoke:notify-coalesce`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" pnpm -w smoke:notify-historyid`; `pnpm -w dev:down`. |
| 10.9.6 | 2026-02-15 | SELF | Added durable processing state for `mail_notification_receipts`, enforced mail-notifications poison protection with permanent fail-fast vs transient retry behavior, and added deterministic `smoke:notify-poison` proof for no retry loop on poison jobs. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `pnpm -w smoke:notify-dedupe`; `pnpm -w smoke:notify-fanout`; `pnpm -w smoke:notify-coalesce`; `pnpm -w smoke:notify-historyid`; `REDIS_URL=\"redis://127.0.0.1:6379\" DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" pnpm -w smoke:notify-poison`; `pnpm -w dev:down`. |
| 10.9.7 | 2026-02-15 | SELF | Added command-first mail operator visibility (`mail:receipts:list/show`, `mailbox:sync:list/show`) and expanded `ops:triage`/`ops:monitor` with mail_notifications + mailbox_sync queues, receipt status counts, and sync lag/error indicators. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" TENANT_ID=\"00000000-0000-0000-0000-000000000001\" pnpm -w mail:receipts:list`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" TENANT_ID=\"00000000-0000-0000-0000-000000000001\" RECEIPT_ID=\"<receipt-id>\" pnpm -w mail:receipts:show`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" TENANT_ID=\"00000000-0000-0000-0000-000000000001\" pnpm -w mailbox:sync:list`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" TENANT_ID=\"00000000-0000-0000-0000-000000000001\" MAILBOX_ID=\"<mailbox-id>\" pnpm -w mailbox:sync:show`; `REDIS_URL=\"redis://127.0.0.1:6379\" DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" TENANT_ID=\"00000000-0000-0000-0000-000000000001\" pnpm -w ops:triage`; `REDIS_URL=\"redis://127.0.0.1:6379\" DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" TENANT_ID=\"00000000-0000-0000-0000-000000000001\" pnpm -w ops:monitor`; `pnpm -w dev:down`. |
| 10.9.8 | 2026-02-15 | SELF | Added safe-by-default replay commands for Gmail notification recovery: `mail:receipts:replay` and `mailbox:sync:replay` with deterministic dry-run/apply output, confirm flags, queue-aware retry/re-enqueue behavior, and runbook guidance for replay incident handling. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" pnpm -w smoke:notify-dedupe`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" REDIS_URL=\"redis://127.0.0.1:6379\" pnpm -w smoke:notify-fanout`; `pnpm -w smoke:notify-coalesce`; `REDIS_URL=\"redis://127.0.0.1:6379\" QUEUE_NAME=\"mail_notifications\" QUEUE_CONTROL_CONFIRM=1 pnpm -w queue:pause`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" REDIS_URL=\"redis://127.0.0.1:6379\" TENANT_ID=\"00000000-0000-0000-0000-000000000001\" RECEIPT_ID=\"$RID_TEST\" pnpm -w mail:receipts:replay`; `... MAIL_RECEIPTS_REPLAY_CONFIRM=1 pnpm -w mail:receipts:replay`; `REDIS_URL=\"redis://127.0.0.1:6379\" QUEUE_NAME=\"mail_notifications\" QUEUE_CONTROL_CONFIRM=1 pnpm -w queue:resume`; `REDIS_URL=\"redis://127.0.0.1:6379\" QUEUE_NAME=\"mailbox_sync\" QUEUE_CONTROL_CONFIRM=1 pnpm -w queue:pause`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" REDIS_URL=\"redis://127.0.0.1:6379\" TENANT_ID=\"00000000-0000-0000-0000-000000000001\" MAILBOX_ID=\"<mailbox-id>\" pnpm -w mailbox:sync:replay`; `... MAILBOX_SYNC_REPLAY_CONFIRM=1 pnpm -w mailbox:sync:replay`; `REDIS_URL=\"redis://127.0.0.1:6379\" QUEUE_NAME=\"mailbox_sync\" QUEUE_CONTROL_CONFIRM=1 pnpm -w queue:resume`; `pnpm -w dev:down`. |
| 10.9.9 | 2026-02-15 | SELF | Added `mailbox_sync_runs` durable ledger + RLS migration, worker mailbox sync history-fetch boundary stub with deterministic `mailbox.sync.run.start|done|error` logs, and deterministic `smoke:mailbox-sync-run` proof for `status='done'` run row by correlationId/mailboxId. | Evidence: `pnpm -w repo:check`; `pnpm -w dev:down \\|\\| true`; `pnpm -w dev:up`; `pnpm -w smoke:correlation`; `DATABASE_URL=\"postgresql://127.0.0.1:5432/ai_email_dev\" pnpm -w smoke:mailbox-sync-run`; `pnpm -w dev:down`. |
