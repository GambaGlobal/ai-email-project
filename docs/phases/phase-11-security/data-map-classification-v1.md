# Phase 11.1 - Data Map + Data Classification (v1)

## A) Purpose + Scope

This document defines the v1 data map and classification baseline for trust posture, sales/security procurement reviews, and engineering guardrails. It states what data the system touches, stores, processes, and shares, why it is needed, and where it lives.

Scope for v1:
- Gmail ingestion path (Gmail API + Pub/Sub notifications)
- Draft generation path (classification, retrieval, LLM draft generation)
- Operator knowledge documents and derived retrieval artifacts
- Observability and audit events
- Token and secret handling (conceptual posture)
- Queue payloads and processing state
- Persistent and transient storage layers

## B) Data Principles (Minimization-First)

Posture: minimized by default.

Defaults for data we do **not** store:
- Raw email bodies and attachments are not persisted by default.
- Full guest email content is not written to logs.
- OAuth access tokens are not stored long-term.

Defaults for data we do store:
- Operator-provided knowledge documents (source of truth), plus derived chunks and embeddings for retrieval.
- Draft artifacts generated by the system (draft text we create), Gmail draft/thread/message references, and citations needed for review.
- Minimal metadata required for threading, routing, idempotency, reliability, and observability.

## C) Data Classification Taxonomy

| Class | Examples | Sensitivity | Handling Rules | Retention Direction |
| --- | --- | --- | --- | --- |
| Credentials/Secrets | OAuth refresh token, API keys, webhook secrets | Critical | Encrypt at rest, strict access controls, never log, rotate/revoke paths | Medium (only while active integration requires it) |
| Customer Content | Guest email body, attachments, subject lines | High | Minimize collection, do not persist raw content by default, never log raw payloads, redact if temporary debug is enabled | Short |
| Customer PII | Guest name, email, phone, address (if present) | High | Least privilege access, redact in logs, avoid unnecessary replication, encrypt at rest where stored | Short to Medium |
| Operator Content | FAQs, itineraries, policies, packing lists, branded reply guidance | Medium | Store as tenant-scoped source of truth, access controlled, integrity/version tracking, no cross-tenant sharing | Medium to Long |
| Derived Data | Embeddings, snippet hashes, intent/classification labels, citations | Medium | Tenant-scoped storage, avoid reversible raw-content reconstruction, hash where possible, redact logs | Medium |
| Telemetry/Operational | Structured logs, metrics, queue/job traces, audit events | Low to Medium | No sensitive payloads, structured redaction, correlation IDs, access controls for operational tooling | Medium |

## D) Data Objects Inventory

| Data Object | Source | Stored? (Default) | Storage Location | Contains PII? | Notes |
| --- | --- | --- | --- | --- | --- |
| Tenant | System/admin setup | Y | Postgres | N | Tenant identity and isolation root key. |
| User (operator/admin) | System/admin setup | Y | Postgres | Y | Minimal operator account/contact metadata. |
| Mailbox Connection | OAuth + provider setup | Y | Postgres (token refs/state), secret storage strategy per Step 11.3 | Maybe | Connection status, scopes, provider IDs; no long-term access token persistence. |
| Gmail Thread Ref | Gmail API | Y | Postgres | Maybe | Store provider thread ID + tenant mailbox linkage only. |
| Gmail Message Ref | Gmail API | Y | Postgres | Maybe | Store provider message IDs, timestamps, minimal routing metadata; no raw body default. |
| Draft Record | System-generated + Gmail API | Y | Postgres + Gmail Drafts | Maybe | Stores generated draft text and provider draft ID/thread linkage; v1 is human-in-control (never auto-send). |
| Classification Result | System-generated | Y | Postgres | Maybe | Labels/reasons/risk flags; avoid raw payload storage. |
| Knowledge Doc | Operator upload | Y | S3-compatible storage + Postgres metadata | Maybe | Canonical operator docs; tenant-scoped source content. |
| Doc Chunk | System-generated from Knowledge Doc | Y | Postgres | Maybe | Chunk text/index metadata; bounded size and tenant-scoped. |
| Embedding Vector | System-generated | Y | Postgres (pgvector) | N/Maybe | Vectorized chunk representation; no standalone guest identity required. |
| Citation | System-generated | Y | Postgres | N/Maybe | References doc/chunk IDs and snippet hashes used to ground draft. |
| Review Flag | System-generated + policy | Y | Postgres | Maybe | Human-review reasons/outcome without storing full raw email. |
| Audit Event | System-generated | Y | Postgres and/or operational logs | N/Maybe | Records security-relevant actions (connect/disconnect, upload/delete) without sensitive payloads. |
| Job Payload | System-generated queue events | Y (minimal) | Redis (BullMQ), limited Postgres state | Maybe | IDs/correlation metadata preferred; avoid raw email bodies in queue payloads. |
| Metrics/Trace | System-generated | Y | Metrics/log system | N/Maybe | Operational health and latency; redacted structured fields only. |

### Core v1 flow (explicit)

1. Gmail push notification arrives via Pub/Sub.
2. System fetches message by provider ID from Gmail API.
3. System classifies for safety/eligibility and extracts only minimal necessary context.
4. System retrieves relevant snippets from operator knowledge docs (not full corpus).
5. System generates draft text and citations.
6. System creates/updates Gmail Draft.
7. System stores metadata, review flags, and citations; does not persist raw email body by default.

### Human review queue storage (without persisting raw email)

For review support, store:
- Tenant/mailbox/thread/message IDs
- Draft text generated by system
- Classification/review reasons and confidence bands
- Citation links/snippet hashes and doc references
- Minimal redacted excerpt only if strictly required and explicitly enabled (off by default)

## E) What We Send to OpenAI (Processing Disclosure)

Inputs sent for draft generation:
- Minimal necessary email excerpt/context for the active thread (not full mailbox history by default)
- Relevant operator knowledge snippets selected by retrieval (not entire document library)
- Applicable policy/tone instructions for the tenant

Outputs received:
- Draft reply text
- Structured grounding/citation data used for operator review and traceability

Use is limited to draft generation assistance. In v1, drafts are never auto-sent; a human operator remains in control.

## F) Redaction + Logging Rules

Never log:
- Raw email bodies
- Attachments
- OAuth/access tokens, refresh tokens, API keys, secrets
- Full sensitive payloads from provider callbacks

Redaction and minimization rules:
- Prefer provider IDs, internal IDs, hashes, and correlation IDs over raw content.
- Store snippet hashes and citation references instead of broad copied content.
- Short redacted excerpts are optional/proposed and off by default; only enabled when strictly required for troubleshooting with explicit controls.
- Audit events capture action metadata (who/what/when/tenant) without sensitive content payloads.

## G) Open Questions / Follow-Ups (Later Steps)

- Optional debug retention window and controls (off by default in v1 baseline).
- Precise TTLs and deletion SLAs (Step 11.4).
- Tenant isolation enforcement mechanisms and proofs (Step 11.2).
- Token encryption and envelope-key strategy details (Step 11.3).
